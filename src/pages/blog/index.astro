---
import Layout from '../../layouts/Layout.astro';
import BlogCard from '../../components/BlogCard.astro';
import { getCollection } from 'astro:content';

const allPosts = await getCollection('posts');
const sortedPosts = allPosts.sort((a, b) => {
  const dateA = new Date(a.data.pubDate);
  const dateB = new Date(b.data.pubDate);
  return dateB.getTime() - dateA.getTime();
});

const allTags = new Set<string>();
allPosts.forEach(post => {
  if (post.data.tags) {
    post.data.tags.forEach((tag: string) => allTags.add(tag));
  }
});
const tags = Array.from(allTags).sort();

const selectedTag = Astro.url.searchParams.get('tag');
const filteredPosts = selectedTag
  ? sortedPosts.filter(post => post.data.tags?.includes(selectedTag))
  : sortedPosts;

const POSTS_PER_PAGE = 9;
const currentPage = parseInt(Astro.url.searchParams.get('page') || '1');
const totalPages = Math.ceil(filteredPosts.length / POSTS_PER_PAGE);
const startIndex = (currentPage - 1) * POSTS_PER_PAGE;
const endIndex = startIndex + POSTS_PER_PAGE;
const currentPosts = filteredPosts.slice(startIndex, endIndex);

const transformedPosts = currentPosts.map(post => ({
  id: post.id,
  title: post.data.title,
  slug: post.slug,
  excerpt: post.data.description || '',
  coverImage: post.data.heroImage,
  date: post.data.pubDate,
  category: post.data.tags?.[0] || 'General',
  tags: post.data.tags || [],
  readTime: post.data.readingTime ? `${post.data.readingTime} 分钟` : '5 分钟'
}));

const paginationItems = Array.from({ length: totalPages }, (_, i) => {
  const page = i + 1;
  const isActive = page === currentPage;
  const showPage = page === 1 || page === totalPages || Math.abs(page - currentPage) <= 1;
  const showDots = !showPage && (page === 2 || page === totalPages - 1);
  return { page, isActive, showPage, showDots };
}).filter(item => item.showPage || item.showDots);

// Base path for GitHub Pages deployment
const basePath = '/astro-blog-2026/';

function getPageUrl(page: number) {
  const params = new URLSearchParams();
  if (selectedTag) params.set('tag', selectedTag);
  if (page > 1) params.set('page', page.toString());
  const queryString = params.toString();
  return queryString ? `${basePath}blog/?${queryString}` : `${basePath}blog/`;
}
---

<Layout title="博客" description="所有博客文章">
  <!-- Page Transition Overlay -->
  <div class="page-transition-overlay" id="page-transition"></div>

  <!-- Hero Section -->
  <div class="relative overflow-hidden bg-gradient-to-b from-primary-50 via-white to-white dark:from-gray-950 dark:via-gray-900 dark:to-gray-900">
    <!-- Animated background -->
    <div class="absolute inset-0 opacity-30 dark:opacity-10">
      <div class="absolute -top-40 -right-40 w-80 h-80 bg-primary-400 rounded-full blur-3xl animate-float"></div>
      <div class="absolute -bottom-40 -left-40 w-80 h-80 bg-accent-400 rounded-full blur-3xl animate-float" style="animation-delay: 3s;"></div>
    </div>
    
    <div class="relative max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-16 sm:py-24">
      <div class="text-center">
        <h1 class="text-4xl sm:text-5xl lg:text-6xl font-bold text-gray-900 dark:text-white mb-6 animate-slide-up">
          全部<span class="gradient-text">文章</span>
        </h1>
        <p class="text-lg sm:text-xl text-gray-600 dark:text-gray-400 max-w-2xl mx-auto animate-slide-up animation-delay-100">
          关于 Web 开发、设计和技术的思考、教程和见解。
        </p>
        
        <!-- Stats -->
        <div class="flex items-center justify-center gap-8 mt-8 animate-slide-up animation-delay-200">
          <div class="text-center animate-scale-entrance" style="animation-delay: 300ms;">
            <div class="text-3xl font-bold gradient-text">{allPosts.length}</div>
            <div class="text-sm text-gray-500 dark:text-gray-400">文章</div>
          </div>
          <div class="w-px h-12 bg-gray-200 dark:bg-gray-700 animate-fade-in" style="animation-delay: 350ms;"></div>
          <div class="text-center animate-scale-entrance" style="animation-delay: 400ms;">
            <div class="text-3xl font-bold gradient-text">{tags.length}</div>
            <div class="text-sm text-gray-500 dark:text-gray-400">话题</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tag Filter -->
  <div class="sticky top-20 z-40 bg-white/80 dark:bg-gray-900/80 backdrop-blur-xl border-b border-gray-200 dark:border-gray-800">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
      <div class="flex items-center gap-3 overflow-x-auto pb-2 scrollbar-hide" id="tag-filter">
        <button
          data-tag=""
          class:list={[
            'tag-pill whitespace-nowrap px-4 py-2 rounded-full text-sm font-medium transition-all duration-300',
            !selectedTag
              ? 'bg-gray-900 dark:bg-white text-white dark:text-gray-900 shadow-lg tag-active'
              : 'bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 hover:scale-105'
          ]}
        >
          全部
        </button>
        {tags.map((tag, index) => (
          <button
            data-tag={tag}
            class:list={[
              'tag-pill whitespace-nowrap px-4 py-2 rounded-full text-sm font-medium transition-all duration-300 animate-scale-entrance',
              selectedTag === tag
                ? 'bg-gray-900 dark:bg-white text-white dark:text-gray-900 shadow-lg tag-active'
                : 'bg-gray-100 dark:bg-gray-800 text-gray-700 dark:text-gray-300 hover:bg-gray-200 dark:hover:bg-gray-700 hover:scale-105'
            ]}
            style={`animation-delay: ${index * 50}ms`}
          >
            #{tag}
          </button>
        ))}
      </div>
    </div>
  </div>

  <!-- Posts Grid -->
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12">
    <div id="posts-container">
      {transformedPosts.length > 0 ? (
        <>
          <div class="posts-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 lg:gap-8" id="posts-grid">
            {transformedPosts.map((post, index) => (
              <div 
                class="post-card animate-card-entrance" 
                data-post-id={post.id}
                style={`animation-delay: ${index * 80}ms`}
              >
                <BlogCard post={post} featured={index === 0 && currentPage === 1 && !selectedTag} />
              </div>
            ))}
          </div>

        <!-- Pagination -->
        {totalPages > 1 && (
          <nav class="mt-16 flex justify-center items-center gap-2 animate-fade-in animation-delay-500" aria-label="Pagination" id="pagination">
            {currentPage > 1 && (
              <a
                href={getPageUrl(currentPage - 1)}
                class="pagination-btn flex items-center gap-2 px-4 py-2 rounded-xl bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:scale-105 active:scale-95 transition-all duration-200"
                data-page={currentPage - 1}
              >
                <svg class="w-4 h-4 transition-transform duration-200 group-hover:-translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
                </svg>
                上一页
              </a>
            )}

            <div class="flex items-center gap-2">
              {paginationItems.map((item, idx) => (
                item.showDots ? (
                  <span class="px-2 text-gray-400 animate-fade-in" style={`animation-delay: ${idx * 50}ms`}>...</span>
                ) : (
                  <a
                    href={getPageUrl(item.page)}
                    class:list={[
                      'pagination-btn w-10 h-10 flex items-center justify-center rounded-xl font-medium transition-all duration-300 animate-scale-entrance',
                      item.isActive
                        ? 'bg-gradient-to-r from-primary-600 to-accent-600 text-white shadow-lg active-page scale-110'
                        : 'bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:scale-110 active:scale-95'
                    ]}
                    data-page={item.page}
                    style={`animation-delay: ${idx * 50}ms`}
                    aria-current={item.isActive ? 'page' : undefined}
                  >
                    {item.page}
                  </a>
                )
              ))}
            </div>

            {currentPage < totalPages && (
              <a
                href={getPageUrl(currentPage + 1)}
                class="pagination-btn flex items-center gap-2 px-4 py-2 rounded-xl bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-50 dark:hover:bg-gray-700 hover:scale-105 active:scale-95 transition-all duration-200"
                data-page={currentPage + 1}
              >
                下一页
                <svg class="w-4 h-4 transition-transform duration-200 group-hover:translate-x-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                </svg>
              </a>
            )}
          </nav>
        )}
      </>
    ) : (
      <div class="empty-state text-center py-20 animate-fade-in">
        <!-- Animated empty state icon -->
        <div class="empty-state-icon-wrapper relative inline-block mb-8">
          <div class="absolute inset-0 bg-gradient-to-br from-primary-400/20 to-accent-400/20 rounded-2xl animate-pulse-slow"></div>
          <div class="empty-state-icon relative inline-flex items-center justify-center w-24 h-24 rounded-2xl bg-gradient-to-br from-gray-100 to-gray-200 dark:from-gray-800 dark:to-gray-900 shadow-lg animate-float">
            <svg class="w-12 h-12 text-gray-400 dark:text-gray-500 animate-pulse" fill="none" viewBox="0 0 24 24" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 20H5a2 2 0 01-2-2V6a2 2 0 012-2h10a2 2 0 012 2v1m2 13a2 2 0 01-2-2V7m2 13a2 2 0 002-2V9a2 2 0 00-2-2h-2m-4-3H9M7 16h6M7 8h6v4H7V8z" />
            </svg>
          </div>
          <!-- Floating particles -->
          <div class="absolute -top-2 -right-2 w-4 h-4 bg-primary-400/40 rounded-full animate-float" style="animation-delay: 0s;"></div>
          <div class="absolute -bottom-1 -left-3 w-3 h-3 bg-accent-400/40 rounded-full animate-float" style="animation-delay: 1s;"></div>
          <div class="absolute top-1/2 -right-4 w-2 h-2 bg-primary-300/50 rounded-full animate-float" style="animation-delay: 2s;"></div>
        </div>
        
        <h2 class="empty-state-text text-2xl font-bold text-gray-900 dark:text-white mb-3 animate-slide-up animation-delay-100">
          暂无文章
        </h2>
        <p class="empty-state-text text-lg text-gray-600 dark:text-gray-400 mb-8 animate-slide-up animation-delay-200">
          {selectedTag ? `没有标签为 "${selectedTag}" 的文章` : '暂无文章。请稍后查看！'}
        </p>
        {selectedTag && (
          <button 
            data-tag=""
            class="tag-pill btn-primary inline-flex items-center gap-2 animate-scale-entrance animation-delay-300 hover:scale-105 active:scale-95 transition-transform duration-200"
          >
            查看全部文章
            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
          </button>
        )}
      </div>
    )}
    </div>
  </div>
</Layout>

<style>
  .scrollbar-hide {
    -ms-overflow-style: none;
    scrollbar-width: none;
  }
  .scrollbar-hide::-webkit-scrollbar {
    display: none;
  }

  /* Tag active state with enhanced animation */
  .tag-active {
    animation: tagActivate 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
  }

  @keyframes tagActivate {
    0% { transform: scale(1); }
    50% { transform: scale(1.15); }
    100% { transform: scale(1); }
  }

  /* Tag ripple effect */
  .tag-ripple {
    position: absolute;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.4);
    transform: scale(0);
    animation: tagRipple 0.6s ease-out forwards;
    pointer-events: none;
  }

  @keyframes tagRipple {
    to {
      transform: scale(4);
      opacity: 0;
    }
  }

  /* Post card animations */
  .post-card {
    transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .post-card.hiding {
    opacity: 0;
    transform: scale(0.9) translateY(20px);
    filter: blur(4px);
  }

  .post-card.showing {
    animation: cardReveal 0.6s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
  }

  @keyframes cardReveal {
    from {
      opacity: 0;
      transform: scale(0.9) translateY(30px);
      filter: blur(4px);
    }
    to {
      opacity: 1;
      transform: scale(1) translateY(0);
      filter: blur(0);
    }
  }

  /* Staggered grid animation */
  .posts-grid {
    animation: gridFadeIn 0.5s ease-out;
  }

  @keyframes gridFadeIn {
    from {
      opacity: 0;
    }
    to {
      opacity: 1;
    }
  }

  /* Empty state animations */
  .empty-state-icon-wrapper {
    animation: emptyStateFloat 3s ease-in-out infinite;
  }

  @keyframes emptyStateFloat {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-10px); }
  }

  /* Slow pulse for background */
  .animate-pulse-slow {
    animation: pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite;
  }

  /* Pagination button hover glow */
  .pagination-btn:not(.active-page):hover {
    box-shadow: 0 0 20px rgba(var(--color-primary-500), 0.2);
  }

  .active-page {
    animation: activePagePulse 2s ease-in-out infinite;
  }

  @keyframes activePagePulse {
    0%, 100% { box-shadow: 0 4px 15px rgba(var(--color-primary-500), 0.3); }
    50% { box-shadow: 0 4px 25px rgba(var(--color-primary-500), 0.5); }
  }

  /* Filter transition for smooth rearrangement */
  .filter-transition {
    transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  }

  /* Page transition overlay */
  .page-transition-overlay {
    position: fixed;
    inset: 0;
    background: linear-gradient(135deg, var(--color-primary-600), var(--color-accent-600));
    z-index: 9999;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
  }

  .page-transition-overlay.active {
    opacity: 1;
    pointer-events: all;
  }

  /* Loading spinner for page transitions */
  .page-transition-overlay.active::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 40px;
    height: 40px;
    margin: -20px 0 0 -20px;
    border: 3px solid rgba(255, 255, 255, 0.3);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }

  @keyframes spin {
    to { transform: rotate(360deg); }
  }
</style>

<script>
  const pageTransition = document.getElementById('page-transition');
  const tagButtons = document.querySelectorAll('.tag-pill[data-tag]');
  const paginationLinks = document.querySelectorAll('.pagination-btn[data-page]');
  const postsContainer = document.getElementById('posts-container');

  function showPageTransition() {
    if (pageTransition) {
      pageTransition.classList.add('active');
    }
  }

  function hidePageTransition() {
    if (pageTransition) {
      pageTransition.classList.remove('active');
    }
  }

  // Enhanced ripple effect with color
  function createRipple(event: MouseEvent, element: HTMLElement) {
    const ripple = document.createElement('span');
    const rect = element.getBoundingClientRect();
    const size = Math.max(rect.width, rect.height);
    const x = event.clientX - rect.left - size / 2;
    const y = event.clientY - rect.top - size / 2;
    
    ripple.style.width = ripple.style.height = `${size}px`;
    ripple.style.left = `${x}px`;
    ripple.style.top = `${y}px`;
    ripple.classList.add('tag-ripple');
    
    element.appendChild(ripple);
    
    setTimeout(() => ripple.remove(), 600);
  }

  // Navigate with enhanced transition
  function navigateWithTransition(url: string) {
    showPageTransition();
    setTimeout(() => {
      window.location.href = url;
    }, 200);
  }

  // Animate cards out with staggered effect
  function animateCardsOut(callback: () => void) {
    const cards = document.querySelectorAll('.post-card');
    const totalDelay = cards.length * 40 + 400;
    
    cards.forEach((card, index) => {
      setTimeout(() => {
        card.classList.add('hiding');
      }, index * 40);
    });
    
    setTimeout(callback, totalDelay);
  }

  // Animate cards in with staggered effect
  function animateCardsIn() {
    const cards = document.querySelectorAll('.post-card');
    cards.forEach((card, index) => {
      card.classList.remove('hiding');
      card.classList.add('showing');
      (card as HTMLElement).style.animationDelay = `${index * 80}ms`;
    });
  }

  // Update active tag state with animation
  function updateActiveTag(clickedTag: string) {
    tagButtons.forEach(btn => {
      const tag = (btn as HTMLElement).dataset.tag;
      if (tag === clickedTag) {
        btn.classList.remove('bg-gray-100', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300');
        btn.classList.add('bg-gray-900', 'dark:bg-white', 'text-white', 'dark:text-gray-900', 'shadow-lg', 'tag-active');
      } else {
        btn.classList.add('bg-gray-100', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300');
        btn.classList.remove('bg-gray-900', 'dark:bg-white', 'text-white', 'dark:text-gray-900', 'shadow-lg', 'tag-active');
      }
    });
  }

  // Tag filter click handler
  tagButtons.forEach(button => {
    button.addEventListener('click', (e) => {
      const target = e.currentTarget as HTMLElement;
      const tag = target.dataset.tag || '';
      
      createRipple(e as MouseEvent, target);
      
      const currentUrl = new URL(window.location.href);
      const currentTag = currentUrl.searchParams.get('tag') || '';
      
      if (tag !== currentTag) {
        updateActiveTag(tag);
        
        animateCardsOut(() => {
          const newUrl = new URL(window.location.origin + '/blog/');
          if (tag) {
            newUrl.searchParams.set('tag', tag);
          }
          navigateWithTransition(newUrl.toString());
        });
      }
    });
  });

  // Pagination click handler with enhanced animation
  paginationLinks.forEach(link => {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      const target = e.currentTarget as HTMLElement;
      const page = target.dataset.page;
      
      if (target.classList.contains('active-page')) return;
      
      // Add click feedback
      target.classList.add('scale-95');
      setTimeout(() => target.classList.remove('scale-95'), 150);
      
      animateCardsOut(() => {
        const currentUrl = new URL(window.location.href);
        const tag = currentUrl.searchParams.get('tag');
        const newUrl = new URL(window.location.origin + '/blog/');
        
        if (tag) newUrl.searchParams.set('tag', tag);
        if (page && page !== '1') newUrl.searchParams.set('page', page);
        
        navigateWithTransition(newUrl.toString());
      });
    });
  });

  // Page load animations
  document.addEventListener('astro:page-load', () => {
    hidePageTransition();
    animateCardsIn();
  });

  // Handle browser back/forward
  window.addEventListener('pageshow', (event) => {
    if (event.persisted) {
      hidePageTransition();
      animateCardsIn();
    }
  });

  // Initial load
  document.addEventListener('DOMContentLoaded', () => {
    hidePageTransition();
    
    // Staggered entrance for initial load
    setTimeout(() => {
      animateCardsIn();
    }, 100);
  });

  // Intersection Observer for scroll-triggered animations
  const observerOptions = {
    threshold: 0.1,
    rootMargin: '0px 0px -50px 0px'
  };

  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.classList.add('animate-visible');
        observer.unobserve(entry.target);
      }
    });
  }, observerOptions);

  // Observe post cards for scroll animations
  document.querySelectorAll('.post-card').forEach(card => {
    observer.observe(card);
  });
</script>
